```
# download
curl  https://download.redis.io/redis-stable.tar.gz -o redis-stable.tar.gz
# unzip
tar -zxvf redis-stable.tar.gz
cd redis-stable
make
# Redis编译时需要使用C/C++环境
# 
sudo yum -y install gcc automake autoconf libtool make
make
# 安装可执行文件到/usr/local/redis
sudo make PREFIX=/usr/local/redis/ install
```



\[jse@MesRedisDev01 redis\]$ cd /usr/local/redis

\[jse@MesRedisDev01 redis\]$ ll

total 0

drwxr-xr-x. 2 root root 134 Jan 28 09:00 bin

\[jse@MesRedisDev01 redis\]$ ls bin

redis-benchmark redis-check-aof redis-check-rdb redis-cli redis-sentinel redis-server



```
#链接
ln -s /usr/local/redis/bin/* /usr/local/bin/

```



```
#创建redis集群目录
mkdir -p /usr/local/redis-cluster
cd /usr/local/redis-cluster
mkdir 6379
mkdir 6380

#创建日志目录
mkdir -p /var/log/redis-cluster


#加载module
cd /usr/local/redis-cluster
mkdir module
#拷贝对应目录的so
cp path/redistimeseries.so /usr/local/redis-cluster/module
chmod u+x redistimeseries.so
```



```
#拷贝对应的配置文件到/usr/local/redis-cluster
cp /home/jse/redis-stable/redis.conf /usr/local/redis-cluster/6379/
cd /usr/local/redis-cluster/6379
cp redis.conf redis.conf
#修改对应的配置文件
#具体参考下面的文件的说明
```

```
#调试启动
/usr/local/redis/bin/redis-server /usr/local/redis-cluster/6379/redis.conf

#查看日志
vim /var/log/redis-cluster/6379.log
```

```
#修改别的的redis.conf
vim redis.conf
#使用%s替换
# :%s/6379/6380/g 
:%s/6379/6380/g
```



### 开机启动

vim redis\_6379.service(6380类似)

```
[Unit]
Description=Redis
After=network.target
# This template unit assumes your redis-server configuration file(s)
# to live at /etc/redis/redis_server_<INSTANCE_NAME>.conf
# AssertPathExists=/etc/redis/redis_server_%i.conf
#Before=your_application.service another_example_application.service
#AssertPathExists=/var/lib/redis

[Service]
ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis-cluster/6379/redis.conf --supervised systemd
ExecStop=/usr/local/redis/bin/redis-cli -p 6379 -a qwe#1234 shutdown
WorkingDirectory=/usr/local/bin
User=root
Group=root
RuntimeDirectory=redis
RuntimeDirectoryMode=0755

#LimitNOFILE=10032
#NoNewPrivileges=yes
##OOMScoreAdjust=-900
##PrivateTmp=yes
#Type=notify
#TimeoutStartSec=infinity
#TimeoutStopSec=infinity
#UMask=0077
#User=redis
#Group=redis
#WorkingDirectory=/var/lib/redis

[Install]
WantedBy=multi-user.target

```

### Create a Redis Cluster

```
# Create a Redis Cluster
redis-cli -a qwe#1234 -p 6379 --cluster create 192.168.205.101:6379 192.168.205.101:6380  192.168.205.102:6379 192.168.205.102:6380  192.168.205.103:6379 192.168.205.103:6380  --cluster-replicas 1 
# --cluster-replicas 1 设置副本节点为 1
# 
# 即一个主节点至少有一个从节点，执行过程会列出 slot 及主从分配

```

添加节点

```
# 添加主节点
# redis-cli --cluster add-node [新加入节点] [原始集群中任意节点]
redis-cli --cluster add-node 192.168.205.103:6379 192.168.205.101:6379 -a qwe#1234 
# 添加slave节点
# redis-cli --cluster add-node --cluster-slave [--master-id master节点id] [新加入节点] [原始集群中任意节点]
redis-cli --cluster add-node --cluster-slave 192.168.205.103:6380 192.168.205.101:6379

```

### 验证

```
#check
redis-cli --cluster check 192.168.205.101:6379 -a qwe#1234

#登录redis集群
redis-cli -a qwe#1234 -h 192.168.205.101 -p 6380 -c
#-a Redis密码,-c表示集群模式 ,指定IP和端口
#注意：可能会redirected进入到其它server

#验证集群信息
192.168.205.101:6380> cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:6
cluster_my_epoch:5
cluster_stats_messages_ping_sent:53811
cluster_stats_messages_pong_sent:52967
cluster_stats_messages_meet_sent:1
cluster_stats_messages_sent:106779
cluster_stats_messages_ping_received:52967
cluster_stats_messages_pong_received:53812
cluster_stats_messages_received:106779
total_cluster_links_buffer_limit_exceeded:0

cluster nodes #查看集群节点列表
```

```
#防火墙放通
firewall-cmd --permanent --add-port=6379/tcp --add-port=6380/tcp
firewall-cmd --reload
```

下载的程序解压后，有安装脚本

utils/install_server.sh



最好配置keepalived的虚拟ip

```
#对应防火墙
firewall-cmd --add-rich-rule='rule protocol value="vrrp" accept'--permanent
```

[https://medium.com/@eldar.karimov/redis-installation-and-cluster-configuration-guide-with-sentinel-and-keepalived-on-centos-redhat-5a70e57e5635](https://medium.com/@eldar.karimov/redis-installation-and-cluster-configuration-guide-with-sentinel-and-keepalived-on-centos-redhat-5a70e57e5635)





### 报错修复

```
[ERR] Not all 16384 slots are covered by nodes.
这个错误往往是由于主节点移除了，但是并没有移除主节点上面的slot，从而导致了slot总数没有达到16384，其实也就是slots分布不正确。所以在删除节点的时候一定要注意删除的是否是master主节点。

# 集群修复
redis-cli --cluster fix 192.168.201.103:6379 -a qwe#1234

[root@MesRedisDev03 redis-cluster]# redis-cli --cluster fix 192.168.201.103:6379                                                                                                                               -a qwe#1234
Warning: Using a password with '-a' or '-u' option on the command line interface                                                                                                                               may not be safe.
192.168.201.103:6379 (38a93597...) -> 35 keys | 5461 slots | 1 slaves.
192.168.201.101:6379 (7a90d956...) -> 42 keys | 5461 slots | 1 slaves.
192.168.201.102:6379 (d5eec132...) -> 34 keys | 5462 slots | 1 slaves.
[OK] 111 keys in 3 masters.
0.01 keys per slot on average.
>>> Performing Cluster Check (using node 192.168.201.103:6379)
M: 38a9359706a30a42c5b5a464a7e500af512c8177 192.168.201.103:6379
   slots:[10923-16383] (5461 slots) master
   1 additional replica(s)
S: c9bb6ea3230c31e5cf06d2d2979dc980dc80cfd9 192.168.201.103:6380
   slots: (0 slots) slave
   replicates d5eec132ad7e1edd4d6a7912fd19494883edb0ca
M: 7a90d956658e23fe1a5d418b6fe17c5d15856490 192.168.201.101:6379
   slots:[0-5460] (5461 slots) master
   1 additional replica(s)
S: f3f4fcb0d1504be2f14a31dcf81f25017309f44e 192.168.201.101:6380
   slots: (0 slots) slave
   replicates 38a9359706a30a42c5b5a464a7e500af512c8177
M: d5eec132ad7e1edd4d6a7912fd19494883edb0ca 192.168.201.102:6379
   slots:[5461-10922] (5462 slots) master
   1 additional replica(s)
S: 3673d08e2c5f88017dbdc43cbfad32d43346522d 192.168.201.102:6380
   slots: (0 slots) slave
   replicates 7a90d956658e23fe1a5d418b6fe17c5d15856490
[OK] All nodes agree about slots configuration.
>>> Check for open slots...
>>> Check slots coverage...
[OK] All 16384 slots covered.
```

